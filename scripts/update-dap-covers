#!/bin/sh

abspath() {
    # Return an absolute path for the specified argument
    _path="$1"
    if [ -n "${_path##/*}" ]; then
        _path="${2:-$(pwd -P)}/$1"
    fi
    echo "$_path"
}

# shellcheck source=./common-music.sh
. "$(dirname "$0")"/common-music.sh

set -e

library_dir="$(beet get-config-path library)"
dap_dir="$(beet get-config-path alternatives.dap.directory)"
if [ -z "$dap_dir" ]; then
    echo >&2 "Error looking up alternatives.dap.directory in beets config"
    exit 1
fi
dap_dir="$(abspath "$dap_dir" "$library_dir")"

cd "$dap_dir" || exit 1

TAB="$(printf '\t')"
beet ls -f '$artpath'"$TAB"'$alt_dap' singleton:false \^alt_dap:/Single\ Tracks/ \^alt_dap:non-album alt_dap- \
    | grep -v "^None$TAB" \
    | sed -e 's#/[^/]*$##' \
    | uniq \
    | while IFS="$TAB" read -r artpath destdir; do
        base="${artpath##*/}"
        destname="$(echo "$base" | sed -e 's/\.[0-9]\././')"
        if [ -e "$base/$destname" ]; then
            if [ -n "$(find "$destdir" -name "$destname" -newer "$artpath")" ]; then
                continue
            fi
            convert "$artpath" -resize 220x220 -bordercolor black -border 10x10 "$destdir/$destname"
        fi
    done
