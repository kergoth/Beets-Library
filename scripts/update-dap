#!/bin/sh

set -e

# shellcheck source=./common-music.sh
. "$(dirname "$0")/common-music.sh"

dap_dir="$(beet get-config-path alternatives.dap.directory)"
if [ -z "$dap_dir" ]; then
    echo >&2 "Error looking up alternatives.dap.directory in beets config"
    exit 1
fi
dap_dir="$(cd "$dap_dir" && pwd -P)"

if [ "$1" = "-f" ]; then
    rm -rf "$dap_dir"/*
else
    find "$dap_dir" -type l \
        | while read -r fn; do test -e "$fn" || echo "$fn"; done \
        | tr '\n' '\0' \
        | xargs -0 rm -fv \
        | sed -e 's,^,-,'
    # Ensure we remove remnants of removed albums
    find "$dap_dir" -iname cover\*.jpg -o -iname cover\*.png \
        | sed -e 's#/[^/]*$##' \
        | while read -r album_dir; do
            if [ -z "$(music_find "$album_dir")" ]; then
                rm -f "$album_dir/cover.jpg" "$album_dir/cover.png" "$album_dir/cover.1.jpg"
            fi
        done
    rm -rf "$dap_dir"/_Playlists
fi
beet splupdate
beet alt update dap --create
beet random -f '$alt_dap' -n 999999999 alt_dap:/Single\ Tracks/ \
    | sed -e 's#.*/DAP/#../#' >"$dap_dir/_Playlists/Random Single Tracks.m3u"
beet random -f '$alt_dap' -n 999999999 alt_dap:/Singles/ \
    | sed -e 's#.*/DAP/#../#' >"$dap_dir/_Playlists/Random Singles.m3u"
"$(dirname "$0")/update-dap-covers"

cd "$dap_dir" || exit 1
if [ -e .git ]; then
    git add . && git commit -m "Update"
fi
