#!/bin/sh
# shellcheck disable=SC2016,SC2115

set -e

msg() {
    printf >&2 "%s: %s\n" "$alternative" "$@"
}

alternative="$1"
directory="$2"

if [ -n "$BEETS_SKIP_HOOKS" ]; then
    exit 0
fi

if [ -d "$directory" ]; then
    msg "Removing dead symlinks"
    find "$directory" -type l \
        | while read -r fn; do test -e "$fn" || echo "$fn"; done \
        | tr '\n' '\0' \
        | xargs -0 rm -fv \
        | sed -e 's,^,-,'

    msg "Removing playlists for re-generation"
    playlistdir="$(beet get-config alternativesplaylist.playlist_dir)" || :
    if [ "$playlistdir" = "null" ]; then
        playlistdir="$(beet get-config playlist.playlist_dir)" || :
        if [ "$playlistdir" = null ]; then
            playlistdir=Playlists
        else
            # FIXME: get a relative path to the library directory
            playlistdir="$(basename "$playlistdir")"
        fi
    fi
    rm -rf "$directory/$playlistdir"
fi

if [ -z "$BEETS_ALT_SKIP_SPL" ]; then
    msg "Updating smart playlists"
    beet splupdate
fi
